---
import ThemeToggle from './ThemeToggle.astro';
import { Briefcase, CodeXml, User, Mail } from '@lucide/astro';
const navItems = [
	{
		title: 'Experiencia',
		label: 'experiencia',
		url: '/#experiencia',
		icon: Briefcase
	},
	{
		title: 'Proyectos',
		label: 'proyectos',
		url: '/#proyectos',
		icon: CodeXml
	},
	{
		title: 'Sobre mí',
		label: 'sobre-mi',
		url: '/#sobre-mi',
		icon: User
	},
	{
		title: 'Contacto',
		label: 'contacto',
		url: 'mailto:contacto@srgobi.com',
		icon: Mail
	}
];
---

<header id="desktop-header" class="md:flex hidden fixed top-0 z-20 w-full items-center justify-center px-8 py-3">
	<!-- Nav + ThemeToggle en una sola píldora -->
	<nav class="desktop-nav flex items-center gap-1 rounded-full px-4 py-2 bg-white/60 dark:bg-zinc-900/60 backdrop-blur-md border border-zinc-200/60 dark:border-zinc-700/50 shadow-sm">
		{
			navItems.map((link) => (
				<a class="desktop-nav-link relative flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 hover:bg-zinc-100/80 dark:hover:bg-zinc-800/80 transition-all duration-200" aria-label={link.label} href={link.url}>
					<link.icon size={14} class="nav-icon shrink-0 opacity-70" />
					{link.title}
					<span class="nav-underline absolute bottom-1 left-3 right-3 h-px bg-blue-500 scale-x-0 transition-transform duration-300 origin-left rounded-full" />
				</a>
			))
		}
		<span class="w-px h-4 bg-zinc-300 dark:bg-zinc-700 mx-1 rounded-full"></span>
		<ThemeToggle />
	</nav>
</header>

<nav class="md:invisible visible fixed bottom-0 left-1/2 -translate-x-1/2 z-50 mb-4 w-[90%] max-w-md rounded-full bg-neutral-200/70 dark:bg-black/50 backdrop-blur-sm shadow-lg mobile-nav" id="mobile-nav">
	<div class="grid h-full grid-cols-4 font-medium py-2 px-2">
		{
			navItems.map((link) => (
				<a href={link.url} class="mobile-nav-item inline-flex flex-col items-center justify-center gap-1 px-2 py-2 hover:bg-white/20 dark:hover:bg-white/10 active:scale-95 group rounded-full transition-all duration-300 ease-in-out" aria-label={link.label} data-section={link.label}>
					<link.icon size={20} class="nav-icon text-zinc-600 dark:text-zinc-400 group-hover:text-blue-600 dark:group-hover:text-blue-500 group-hover:scale-110 transition-all duration-300" />
					<span class="nav-text text-[10px] font-medium text-zinc-600 dark:text-zinc-400 group-hover:text-blue-600 dark:group-hover:text-blue-500 transition-all duration-300">{link.title}</span>
				</a>
			))
		}
	</div>
</nav>

<script>
	document.addEventListener('astro:page-load', () => {
		const sections = document.querySelectorAll('section[id]');
		const headerNavItems = document.querySelectorAll('.desktop-nav a');
		const mobileNavItems = document.querySelectorAll('.mobile-nav a');

		// Track intersection ratio per section to always pick the most visible one
		const visibleSections = new Map<string, number>();

		const updateNav = (sectionId: string) => {
			headerNavItems.forEach((item) => {
				const isActive = item.getAttribute('aria-label') === sectionId;
				item.classList.toggle('text-blue-500', isActive);
				item.classList.toggle('dark:text-blue-400', isActive);
				item.classList.toggle('bg-blue-50/80', isActive);
				item.classList.toggle('dark:bg-blue-500/10', isActive);
				const underline = item.querySelector('.nav-underline') as HTMLElement | null;
				if (underline) underline.style.transform = isActive ? 'scaleX(1)' : 'scaleX(0)';
			});
			mobileNavItems.forEach((item) => {
				item.classList.toggle('active', item.getAttribute('data-section') === sectionId);
			});
		};

		const getActiveSection = (): string => {
			let maxRatio = 0;
			let activeId = '';
			visibleSections.forEach((ratio, id) => {
				if (ratio > maxRatio) {
					maxRatio = ratio;
					activeId = id;
				}
			});
			return activeId;
		};

		const callback = (entries: IntersectionObserverEntry[]) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					visibleSections.set(entry.target.id, entry.intersectionRatio);
				} else {
					visibleSections.delete(entry.target.id);
				}
			});

			const activeSection = getActiveSection();
			if (activeSection) updateNav(activeSection);
		};

		const observer = new IntersectionObserver(callback, {
			root: null,
			rootMargin: '-15% 0px -55% 0px',
			threshold: Array.from({ length: 11 }, (_, i) => i / 10)
		});

		sections.forEach((section) => observer.observe(section));

		// Handle initial hash without artificial delays
		const hash = window.location.hash.slice(1);
		if (hash) updateNav(hash);

		// --- Hide mobile nav on scroll down, show on scroll up ---
		const mobileNav = document.getElementById('mobile-nav');
		let lastScrollY = window.scrollY;
		let scrollTicking = false;

		const handleScroll = () => {
			if (!scrollTicking) {
				requestAnimationFrame(() => {
					const currentScrollY = window.scrollY;
					const scrollingDown = currentScrollY > lastScrollY;
					const nearBottom = window.innerHeight + currentScrollY >= document.documentElement.scrollHeight - 80;

					if (mobileNav) {
						if (scrollingDown || nearBottom) {
							mobileNav.classList.add('mobile-nav-hidden');
						} else {
							mobileNav.classList.remove('mobile-nav-hidden');
						}
					}

					lastScrollY = currentScrollY;
					scrollTicking = false;
				});
				scrollTicking = true;
			}
		};

		window.addEventListener('scroll', handleScroll, { passive: true });

		// --- Hide both navs when a modal is open ---
		const desktopHeader = document.getElementById('desktop-header');

		const updateHeadersForModals = () => {
			const anyOpen = Array.from(document.querySelectorAll<HTMLInputElement>('input[type="checkbox"][data-modal]')).some((cb) => cb.checked);
			if (mobileNav) mobileNav.classList.toggle('mobile-nav-hidden', anyOpen);
			if (desktopHeader) desktopHeader.classList.toggle('header-hidden', anyOpen);
		};

		document.addEventListener('change', (e) => {
			const target = e.target as HTMLInputElement;
			if (target.type === 'checkbox' && target.hasAttribute('data-modal')) {
				updateHeadersForModals();
			}
		});

		document.onvisibilitychange = () => {
			if (document.visibilityState === 'hidden') observer.disconnect();
		};
	});
</script>

<style>
	header {
		/* Sin transform ni animación en el header para evitar stacking context
		   que bloquearía backdrop-filter en la nav pill hija */
		transition: opacity 0.35s ease;
	}

	header.header-hidden {
		opacity: 0;
		pointer-events: none;
	}

	.desktop-nav {
		animation: nav-slide-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
		transition:
			transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
			opacity 0.35s ease;
	}

	header.header-hidden .desktop-nav {
		transform: translateY(-5rem);
		opacity: 0;
		pointer-events: none;
	}

	.mobile-nav {
		animation: mobile-nav-shadown 1s linear both;
		animation-timeline: scroll();
		animation-range: 0 400px;
		transition:
			bottom 0.35s cubic-bezier(0.4, 0, 0.2, 1),
			opacity 0.35s ease;
	}

	.mobile-nav.mobile-nav-hidden {
		bottom: -5rem;
		opacity: 0;
		pointer-events: none;
	}

	/* Estado activo para navegación móvil */
	.mobile-nav-item.active {
		background-color: rgba(255, 255, 255, 0.2);
		transform: scale(1.05);
	}

	:global(.dark) .mobile-nav-item.active {
		background-color: rgba(255, 255, 255, 0.1);
	}

	.mobile-nav-item.active .nav-icon,
	.mobile-nav-item.active .nav-text {
		color: rgb(37 99 235) !important;
	}

	:global(.dark) .mobile-nav-item.active .nav-icon,
	:global(.dark) .mobile-nav-item.active .nav-text {
		color: rgb(59 130 246) !important;
	}

	.mobile-nav-item.active .nav-icon {
		transform: scale(1.1);
	}

	@keyframes nav-slide-in {
		from {
			transform: translateY(-3rem);
			opacity: 0;
		}
		to {
			transform: translateY(0);
			opacity: 1;
		}
	}

	@keyframes nav-shadown {
		to {
			box-shadow:
				0 10px 15px -3px rgba(0, 0, 0, 0.1),
				0 4px 6px -2px rgba(0, 0, 0, 0.05);
		}
	}

	@keyframes mobile-nav-shadown {
		to {
			box-shadow:
				0 -10px 25px -5px rgba(0, 0, 0, 0.15),
				0 -8px 10px -6px rgba(0, 0, 0, 0.1);
		}
	}
</style>
